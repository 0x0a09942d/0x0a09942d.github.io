<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!--
	XML data was compiled by a reddit community for use with the "Fight Club 5" app.
	Google "5e xml files" for more info.

	Feel free to use, edit, and redistribute this as you wish.
	I don't own any of the XML data anyway.
-->

<title>CR Calc - 5etools</title>

<link rel="stylesheet" href="css/bootstrap.css">

<style type="text/css">
header {
	padding: 25px 15px;
	color: white;
	background-color: rgb(0, 107, 196);
}

header p.lead {
	color: lightgrey;
}


main {
	padding: 10px 15px;
}

footer {
	padding: 20px 15px;
	font-size: 90%;
}

#crcalc input[type=number], #crcalc input[type=checkbox], .inputwrap {
	left: 15em;
	text-align: right;
	clear: both;
	margin-bottom: 2px;
	width: 6em;
	float: right;
}

#crcalc select {
	margin-left: -1.1em;
	border-radius: 3px;
}
#crcalc input[type=checkbox] {
	width: auto;
}

#crcalc input#hd {
	float: none;
	width: 2em;
}

input[type=number]#hd::-webkit-inner-spin-button,
input[type=number]#hd::-webkit-outer-spin-button {
	-webkit-appearance: none;
	margin: 0;
}

#crcalc label span.explanation {
	display: none;
	font-weight: normal;
	position: absolute;
	background: white;
	border: 1px solid lightgrey;
	border-radius: 3px;
	padding: 3px;
}

#crcalc label:hover span.explanation {
	display: block;
	width: 18em;
	font-size: 0.8em;
}

#crcalc input#hd:focus {
	border: 1px solid initial;
}

#msbcr {
	text-align: center;
	font-size: 0.8em;
}

#msbcr th {
	text-align: center;
	padding: 0 0.5em;
	cursor: initial!important;
}

#msbcr tr:nth-child(even) {
	background: lightgrey;
}

#msbcr tr {
	cursor: pointer;
}

#output {
	padding: 0.2em;
	background: lightgrey;
	border-radius: 0.2em;
}

#instructions p {
	font-size: small;
}
</style>


<script type="text/javascript">

function parsesize (size) {
	if (size == "T") size = "Tiny";
	if (size == "S") size = "Small";
	if (size == "M") size = "Medium";
	if (size == "L") size = "Large";
	if (size == "H") size = "Huge";
	if (size == "G") size = "Gargantuan";
	return size;
}

var xpchart = [200, 450, 700, 1100, 1800, 2300, 2900, 3900, 5000, 5900, 7200, 8400, 10000, 11500, 13000, 15000, 18000, 20000, 22000, 25000, 30000, 41000, 50000, 62000, 75000, 90000, 105000, 102000, 135000, 155000]

window.onload = loadpage;

function loadpage() {
	for (var i = 0; i < msbcr.cr.length; i++) {
		var curcr = msbcr.cr[i];
		$("#msbcr").append("<tr><td>"+curcr._cr+"</td><td>"+curcr.pb+"</td><td>"+curcr.ac+"</td><td>"+curcr.hpmin+"-"+curcr.hpmax+"</td><td>"+curcr.attackbonus+"</td><td>"+curcr.dprmin+"-"+curcr.dprmax+"</td><td>"+curcr.savedc+"</td></tr>")
	}

	$("input#calculate").click(function() {
		calculatecr();
	})

	$("#crcalc input").focusout(function() {
		calculatecr();
	})

	$("#saveinstead").change(function() {
		var curval = parseInt($("#attackbonus").val());
		if (!$(this).is(":checked")) $("#attackbonus").val(curval-10);
		if ($(this).is(":checked")) $("#attackbonus").val(curval+10);
		calculatcr();
	});

	$("select#size").change(function() {
		var newsize = $(this).val();
		if (newsize == "Tiny") $("#hdval").html("d4")
		if (newsize == "Small") $("#hdval").html("d6")
		if (newsize == "Medium") $("#hdval").html("d8")
		if (newsize == "Large") $("#hdval").html("d10")
		if (newsize == "Huge") $("#hdval").html("d12")
		if (newsize == "Gargantuan") $("#hdval").html("d20")
	});

	$("#calculatehp").click(function() {
		var avghp = $("#hdval").html().split("d")[1]/2+1;
		var conmod = Math.floor(($("#con").val() - 10) / 2);
		$("#hp").val((avghp + conmod)* $("#hd").val());
	});

	$("#msbcr tr").not(":has(th)").click(function() {
		$("#hp").val($(this).children("td:eq(3)").html().split("-")[0])
		$("#ac").val($(this).children("td:eq(2)").html())
		$("#dpr").val($(this).children("td:eq(5)").html().split("-")[0])
		$("#attackbonus").val($(this).children("td:eq(4)").html())
		if ($("#saveinstead").is(":checked")) $("#attackbonus").val($(this).children("td:eq(6)").html())
		calculatecr();
	});

	$("#hp").focusout(function() {
		calculatehd();
	});

	if (window.location.hash) {
		var curdata = window.location.hash.split("#")[1].split(",")
		$("#hp").val(curdata[0]);
		$("#ac").val(curdata[1]);
		$("#dpr").val(curdata[2]);
		$("#attackbonus").val(curdata[3]);
		if (curdata[4] === "true") $("#saveinstead").attr("checked",true);
	}

	calculatecr();
}

function calculatecr() {
	var hp = parseInt($("#crcalc #hp").val());
	var ac = parseInt($("#crcalc #ac").val());
	var dpr = parseInt($("#crcalc #dpr").val());
	var attackbonus = parseInt($("#crcalc #attackbonus").val());
	var usesavedc = $("#saveinstead").is(":checked");

	var offensiveCR = -1;
	var defensiveCR = -1;

	for (var i = 0; i < msbcr.cr.length; i++) {
		var curcr = msbcr.cr[i];
		if (hp >= parseInt(curcr.hpmin) && hp <= parseInt(curcr.hpmax)) {
			var defensedifference = i - Math.floor ((parseInt(curcr.ac) - ac) / 2);
			if (defensedifference < 0) defensedifference = 0;
			if (defensedifference > msbcr.length) defensedifference = msbcr.length-1;
			defensiveCR = msbcr.cr[defensedifference]._cr;
		}
		if (dpr >= curcr.dprmin && dpr <= curcr.dprmax) {
			var adjuster = parseInt(curcr.attackbonus);
			if (usesavedc) adjuster = parseInt(curcr.savedc);
			var attackdifference = i - Math.floor ((adjuster - attackbonus) / 2);
			if (attackdifference < 0) attackdifference = 0;
			if (attackdifference > msbcr.length) attackdifference = msbcr.length-1;
			offensiveCR = msbcr.cr[attackdifference]._cr;
		}
	}


	var cr = ((eval(offensiveCR) + eval(defensiveCR)) / 2).toString();

	if (cr == "0.5625") cr = "1/2"
	if (cr == "0.5") cr = "1/2"
	if (cr == "0.375") cr = "1/4"
	if (cr == "0.3125") cr = "1/4"
	if (cr == "0.25") cr = "1/4"
	if (cr == "0.1875") cr = "1/8"
	if (cr == "0.125") cr = "1/8"
	if (cr == "0.0625") cr = "1/8"
	if (cr.indexOf(".") !== -1) cr = Math.round(cr);

	var finalcr = 0;
	for (var i = 0; i < msbcr.cr.length; i++) {
		if (msbcr.cr[i]._cr === cr) {
			finalcr = i;
			break;
		}
	}

	calculatehd();

	window.location = "#"+$("#hp").val()+","+$("#ac").val()+","+$("#dpr").val()+","+$("#attackbonus").val()+","+usesavedc;
	$("#output").html("<h4>Challenge Rating: "+cr+"</h4>");
	$("#output").append("<p>Offensive CR: +"+offensiveCR+"</p>");
	$("#output").append("<p>Defensive CR: +"+defensiveCR+"</p>");
	$("#output").append("<p>Proficiency Bonus: +"+msbcr.cr[finalcr].pb+"</p>");
}

function calculatehd() {
	var avghp = $("#hdval").html().split("d")[1]/2+1;
	var conmod = Math.floor(($("#con").val() - 10) / 2);
	var curhd = Math.floor(parseInt($("#hp").val()) / (avghp + conmod));
	if (!curhd) curhd = 1;
	$("#hd").val(curhd);
}
</script>


</head>
<body>
	<header class="hidden-xs hidden-sm">
		<div class="container">

			<h1>CR Calculator</h1>
			<p>Put in the values and press calculate</p>
		</div>
	</header>
	<nav class="container">
		<ul class="nav nav-pills">
			<li role="presentation"><a href=".">5eTools</a></li>
			<li role="presentation"><a href="classes.html">Classes</a></li>
			<li role="presentation"><a href="bestiary.html">Bestiary</a></li>
			<li role="presentation"><a href="items.html">Items</a></li>
			<li role="presentation"><a href="backgrounds.html">Backgrounds</a></li>
			<li role="presentation"><a href="feats.html">Feats</a></li>
			<li role="presentation"><a href="races.html">Races</a></li>
			<li role="presentation"><a href="spells.html">Spells</a></li>
			<li role="presentation" class="active"><a href="crcalculator.html">CR Calc</a></li>
		</ul>
	</nav>
	<main class="container bodyContent">

		<div class="row">
			<div class="col-sm-6">
				<form id="crcalc" autocomplete="off">
					<div>
						<h4>CR Calculation</h4>
						<label for="hp">Hit Points
							<span class="explanation">
								A creature's hit points determine its defensive CR before it is adjusted by its AC.
							</span>
						</label>
						<input type="number" id="hp" placeholder="Average HP" value="1" min="0" max="850"><br />

						<label for="ac">Armor Class
							<span class="explanation">
								A creature's AC adjusts its defensive CR.
							</span>
						</label>
						<input type="number" id="ac" placeholder="AC" value="13" min="1" max="40"><br />

						<label for="dpr">Damage Per Round
							<span class="explanation">
								A creature's damage per round (DPR) determines its offensive CR, which is offset by its attack bonus or save DC. DPR is determined by averaging its maximum damage output (taking the average of dice rolls, ignoring crits and accuracy) over three rounds. Areas of effect are treated as though they hit two creatures, which fail any involved saving throws.
							</span>
						</label>
						<input type="number" id="dpr" placeholder="Average DPR" value="1" min="0" max="320"><br />

						<label for="attackbonus">Attack Bonus/Save DC
							<span class="explanation">
								A creature's attack bonus or save DC adjuts its offensive CR.
							</span>
						</label>

						<input type="number" id="attackbonus" placeholder="Attack Bonus" value="3" min="-5" max="19"><br>
						<label for="saveinstead">Use Saves?
							<span class="explanation">
								If a creature's damage output is more dependent on save-based abilities, its save DC is used for adjusting its offensive CR instead of its attack bonus.
							</span>
						</label>
						<input type="checkbox" id="saveinstead" value="0"><br>
						<input type="button" id="calculate" value="Calculate"><br><br>
						<div id="output">Waiting for calculation...</div>
					</div>
					<hr>
					<div>
						<h4>Hit Points</h4>
						<label for="size">Size:
							<span class="explanation">
								A creature's size determines the size of its individual hit dice.
							</span>
						</label>
						<span class="inputwrap">
							<select id="size">
								<option value="Tiny">Tiny</option>
								<option value="Small">Small</option>
								<option value="Medium" selected>Medium</option>
								<option value="Large">Large</option>
								<option value="Huge">Huge</option>
								<option value="Gargantuan">Gargantuan</option>
							</select>
						</span><br />
						<label for="hd">Hit Dice:
							<span class="explanation">
								Unlike player characters, the number of hit dice an NPC gets is completely arbitrary. Adjust this amount to taste.
							</span>
						</label> <span class="inputwrap"><input type="number" id="hd" value="1"><span id="hdval">d8</span></span><br />
						<label for="con">Constitution:
							<span class="explanation">
								A creature's HP is increases by its Constitution modifier for each hit die it has.
							</span>
						</label><input type="number" id="con" value="10" min="1" max="30"><br>
						<input type="button" id="calculatehp" value="Calculate Average HP"><br>
					</div>
				</form>
			</div>
			<div class="col-sm-6">
				<h4>Monster Statistics by Challenge Rating</h4>
				<table id="msbcr">
					<tr>
						<th>CR</th>
						<th>Prof. Bonus</th>
						<th>Armor Class</th>
						<th>Hit Points</th>
						<th>Attack Bonus</th>
						<th>Damage/Round</th>
						<th>Save DC</th>
					</tr>
				</table>
				<br>
				<small>
					<p><strong>Protip:</strong> Click a row to load in that CR's average stats.</p>
				</small>
			</div>

		</div>
		<div class="row">
			<div class="col-sm-12" id="instructions">
				<h3>Instructions</h3>
				<p>Be sure to read the <em>Dungeon Master's Guide</em> section on monster creation, pages 273 through 283.</p>
				<h4>What is CR?</h4>
				<p>CR is how strong a creature is. It is the average of two values: defensive CR and offensive CR.</p>
				<p>Defensive CR is based on the MSbCR chart to the right. Match HP to a given CR, then offset that by half the difference of the creature's AC from that CR's AC value.</p>
				<p>Similarly, offensive CR is based on damage per round (DPR) offset by their attack bonus or save DC difference. Use whichever of the two is more pertitent to the creature's damage output.</p>
				<h4>Calculating Hit Points</h4>
				<p>You can calculate average HP based on hit die. Adjust the size, number of hit dice, and the Constitution modifier of the creature.</p>

			</div>
		</div>

	</main>


	<!--
	All the embedded crap.
	Would load it in but I want this for offline use too
-->
<script type="text/javascript" src="data/msbcr.json"></script>
<script type="text/javascript" src="js/list.js"></script>
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/bootstrap.js"></script>


</body>
</html>
